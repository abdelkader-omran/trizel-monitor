name: Data Governance Validation

on:
  push:
    branches: [ main, "copilot/**" ]
    paths:
      - 'data/**'
      - 'src/**'
      - '.github/workflows/validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Data Governance Validator
        id: validate
        run: |
          echo "Running TRIZEL Data Governance Validator..."
          python src/validate_data.py
          
      - name: Check for MD5 in codebase
        run: |
          echo "Checking for forbidden MD5 usage..."
          if grep -ri "md5" --include="*.py" --include="*.json" --exclude-dir=".git" .; then
            echo "ERROR: MD5 checksums are FORBIDDEN (cryptographically broken)"
            echo "Use SHA-256 only. See DATA_CONTRACT.md section 7."
            exit 1
          fi
          echo "âœ“ No MD5 usage found"

      - name: Validation Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Data Governance Validation Complete"
          echo "=========================================="
          echo "See DATA_CONTRACT.md and ISSUE_AUTHORITATIVE_DATA_GOVERNANCE.md"
          echo "for complete specification."
